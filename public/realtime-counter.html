<!DOCTYPE html>
<html>
<head>
    <title>Test Contador Tiempo Real</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #1a1a1a; color: white; }
        .counter { font-size: 48px; font-weight: bold; color: #00ff88; text-align: center; margin: 20px 0; }
        .status { color: #ffaa00; text-align: center; }
        .log { background: #333; padding: 10px; margin: 10px 0; border-radius: 5px; height: 200px; overflow-y: auto; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; margin: 10px; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>üéµ RDOMI - Contador Tiempo Real</h1>
    
    <div class="status" id="status">Conectando...</div>
    
    <div>
        <label>Service ID: </label>
        <input type="number" id="serviceInput" value="1596" style="background: #333; color: white; border: 1px solid #555; padding: 5px; border-radius: 3px;">
        <button onclick="updateServiceId()">üîÑ Cambiar</button>
    </div>
    
    <h2>Estaci√≥n <span id="currentServiceId">1596</span>:</h2>
    <div class="counter" id="counter">---</div>
    
    <div>
        <button onclick="getInitialCount()">üìä Actualizar Contador</button>
        <button onclick="clearLogs()">üóëÔ∏è Limpiar Logs</button>
        <br><br>
        <p style="color: #ffaa00; font-size: 14px;">
            üí° El contador se actualiza autom√°ticamente cuando alguien entra a esta estaci√≥n
        </p>
    </div>
    
    <h3>üìä Logs en Tiempo Real:</h3>
    <div class="log" id="logs"></div>

    <script>
        let SERVICE_ID = 1596; // ID de estaci√≥n de prueba - CAMBIAR POR UNO REAL
        let currentCount = 0;
        
        // Conectar al WebSocket
        const socket = io('https://rx.netdomi.com:3001');
        
        const statusEl = document.getElementById('status');
        const counterEl = document.getElementById('counter');
        const logsEl = document.getElementById('logs');
        const serviceInputEl = document.getElementById('serviceInput');
        const currentServiceIdEl = document.getElementById('currentServiceId');
        
        function addLog(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const color = type === 'success' ? '#00ff88' : type === 'error' ? '#ff4444' : '#ffaa00';
            logsEl.innerHTML += `<div style="color: ${color}">[${time}] ${message}</div>`;
            logsEl.scrollTop = logsEl.scrollHeight;
        }
        
        // Eventos WebSocket
        socket.on('connect', () => {
            statusEl.textContent = '‚úÖ Conectado al WebSocket';
            statusEl.style.color = '#00ff88';
            addLog('‚úÖ Conectado al servidor WebSocket', 'success');
        });
        
        socket.on('disconnect', () => {
            statusEl.textContent = '‚ùå Desconectado';
            statusEl.style.color = '#ff4444';
            addLog('‚ùå Desconectado del servidor', 'error');
        });
        
        socket.on('updateCounter', (data) => {
            addLog(`üìä Update recibido: ${JSON.stringify(data)}`, 'success');
            
            if (data.service_id == SERVICE_ID) {
                const newCount = data.current_count || data.total || currentCount + 1;
                
                // Animaci√≥n del contador
                animateCounter(currentCount, newCount);
                currentCount = newCount;
                
                addLog(`üî• CONTADOR ACTUALIZADO: ${newCount}`, 'success');
            }
        });
        
        function animateCounter(from, to) {
            const duration = 500;
            const step = (to - from) / (duration / 16);
            let current = from;
            
            const animate = () => {
                current += step;
                if ((step > 0 && current >= to) || (step < 0 && current <= to)) {
                    counterEl.textContent = to.toLocaleString();
                    return;
                }
                counterEl.textContent = Math.floor(current).toLocaleString();
                requestAnimationFrame(animate);
            };
            animate();
        }
        
        // Funciones de utilidad - SIMPLIFICADAS
        
        function clearLogs() {
            logsEl.innerHTML = '';
        }
        
        function updateServiceId() {
            SERVICE_ID = parseInt(serviceInputEl.value);
            currentServiceIdEl.textContent = SERVICE_ID;
            addLog(`üîÑ Service ID cambiado a: ${SERVICE_ID}`, 'info');
            getInitialCount();
        }
        
        function getInitialCount() {
            addLog(`üîÑ Obteniendo contador para service_id: ${SERVICE_ID}...`);
            
            fetch(`https://rdomint.com/api/rdomi/sts/service/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ service_id: SERVICE_ID })
            })
            .then(r => r.json())
            .then(data => {
                console.log('Respuesta API status:', data);
                currentCount = data.count || 0;
                counterEl.textContent = currentCount.toLocaleString();
                addLog(`üìä Contador actual: ${currentCount}`, 'success');
            })
            .catch(e => {
                addLog(`‚ùå Error obteniendo contador: ${e.message}`, 'error');
                console.error('Error:', e);
                currentCount = 0;
                counterEl.textContent = '0';
                addLog(`üìä Iniciando contador en 0`, 'info');
            });
        }
        
        // Obtener contador inicial al cargar la p√°gina
        setTimeout(() => {
            getInitialCount();
        }, 1000);
    </script>
</body>
</html>