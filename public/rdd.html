<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ RDOMI WebSocket & Stats Tester - COMPLETE SYSTEM</title>
    <style>
        body {
            font-family: monospace;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            width: 100%;
            padding: 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .debug {
            background: #e2e3e5;
            color: #383d41;
            border: 1px solid #d6d8db;
        }
        .websocket {
            background: #cce5ff;
            color: #004085;
            border: 1px solid #b3d9ff;
        }
        .info {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid #007bff;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background: #e9ecef;
            border: none;
            cursor: pointer;
            font-size: 14px;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        .tab.active {
            background: #007bff;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-online { background: #28a745; }
        .status-offline { background: #dc3545; }
        .status-connecting { background: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ RDOMI WebSocket & Stats Tester</h1>
        <p><strong>Sistema Completo:</strong> Test de estad√≠sticas manuales + WebSocket en tiempo real + CORS</p>
        
        <!-- Status Indicators -->
        <div id="system-status" class="result info">
            <strong>üîÑ Estado del Sistema:</strong><br>
            <span class="status-indicator status-offline" id="websocket-status"></span>WebSocket: <span id="websocket-text">Desconectado</span><br>
            <span class="status-indicator status-offline" id="api-status"></span>API Laravel: <span id="api-text">No verificado</span>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('manual-increment')">üìä Incremento Manual</button>
            <button class="tab" onclick="switchTab('websocket-test')">üîå WebSocket Test</button>
            <button class="tab" onclick="switchTab('system-check')">‚öôÔ∏è Sistema Check</button>
        </div>

        <!-- Tab 1: Manual Increment -->
        <div id="manual-increment" class="tab-content active">
            <h3>üìä Test Incremento Manual de Estad√≠sticas</h3>
            <form id="testForm">
                <div class="form-group">
                    <label for="serviceId">Service ID (Estaci√≥n):</label>
                    <input type="number" id="serviceId" value="1596" required>
                </div>
                
                <div class="form-group">
                    <label for="incrementAmount">Cantidad a incrementar:</label>
                    <input type="number" id="incrementAmount" value="1" min="1" max="1000" required>
                </div>
                
                <div class="form-group">
                    <label for="adminKey">Clave Admin:</label>
                    <input type="text" id="adminKey" value="RDOMI_ADMIN_2024" required>
                </div>
                
                <button type="submit">üöÄ Incrementar Estad√≠sticas</button>
            </form>
        </div>

        <!-- Tab 2: WebSocket Test -->
        <div id="websocket-test" class="tab-content">
            <h3>üîå Test WebSocket en Tiempo Real</h3>
            <div class="form-group">
                <label for="ws-service-id">Service ID para escuchar:</label>
                <input type="number" id="ws-service-id" value="1596">
            </div>
            <button onclick="connectWebSocket()">üîå Conectar WebSocket</button>
            <button onclick="disconnectWebSocket()">‚ùå Desconectar</button>
            <button onclick="sendTestMessage()">üì§ Enviar Mensaje Test</button>
            
            <div id="websocket-messages" class="result websocket" style="display: none;">
                <strong>üì° Mensajes WebSocket:</strong><br>
                <div id="ws-content"></div>
            </div>
        </div>

        <!-- Tab 3: System Check -->
        <div id="system-check" class="tab-content">
            <h3>‚öôÔ∏è Verificaci√≥n Completa del Sistema</h3>
            <button onclick="checkSystemHealth()">üîç Verificar Sistema Completo</button>
            <button onclick="testCORS()">üåê Test CORS</button>
            <button onclick="checkWebSocketServer()">‚ö° Check WebSocket Server</button>
            
            <div id="system-results" class="result info" style="display: none;"></div>
        </div>

        <!-- Results -->
        <div id="debug-info" class="result debug" style="display: none;"></div>
        <div id="result" class="result" style="display: none;"></div>
    </div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        // Configuraci√≥n
        const API_BASE = window.location.origin + '/api';
        const WEBSOCKET_URL = 'https://rx.netdomi.com';
        const endpoints = {
            manualIncrement: `${API_BASE}/rdomi/sts/admin/manual-increment`,
            websocketPing: `https://rx.netdomi.com/api/websocket-ping`,
            health: `https://rx.netdomi.com:3001/health`
        };

        // Variables globales
        let socket = null;
        let isWebSocketConnected = false;

        // Utilidades
        function showDebug(info) {
            const debugDiv = document.getElementById('debug-info');
            debugDiv.textContent = JSON.stringify(info, null, 2);
            debugDiv.style.display = 'block';
        }

        function showResult(message, type = 'debug') {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = message;
            resultDiv.className = `result ${type}`;
            resultDiv.style.display = 'block';
        }

        function updateStatus(type, status, text) {
            const indicator = document.getElementById(`${type}-status`);
            const textElement = document.getElementById(`${type}-text`);
            
            indicator.className = `status-indicator status-${status}`;
            textElement.textContent = text;
        }

        function switchTab(tabName) {
            // Ocultar todos los tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar tab seleccionado
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Tab 1: Manual Increment
        document.getElementById('testForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const serviceId = parseInt(document.getElementById('serviceId').value);
            const incrementAmount = parseInt(document.getElementById('incrementAmount').value);
            const adminKey = document.getElementById('adminKey').value.trim();

            const payload = {
                service_id: serviceId,
                increment_amount: incrementAmount,
                admin_key: adminKey
            };

            showDebug({
                timestamp: new Date().toISOString(),
                endpoint: endpoints.manualIncrement,
                method: 'POST',
                payload: payload,
                status: 'Enviando petici√≥n...'
            });

            try {
                const response = await fetch(endpoints.manualIncrement, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(payload)
                });

                const responseData = await response.json();

                showDebug({
                    timestamp: new Date().toISOString(),
                    endpoint: endpoints.manualIncrement,
                    method: 'POST',
                    payload: payload,
                    response_status: response.status,
                    response_ok: response.ok,
                    response_headers: Object.fromEntries(response.headers.entries()),
                    response_data: responseData
                });

                if (response.ok) {
                    showResult(`‚úÖ √âXITO!\n\nRespuesta:\n${JSON.stringify(responseData, null, 2)}\n\nüîî Si el WebSocket est√° conectado, deber√≠as ver el mensaje en tiempo real.`, 'success');
                    updateStatus('api', 'online', 'Funcionando correctamente');
                } else {
                    showResult(`‚ùå ERROR ${response.status}\n\nRespuesta:\n${JSON.stringify(responseData, null, 2)}`, 'error');
                    updateStatus('api', 'offline', `Error ${response.status}`);
                }

            } catch (error) {
                showDebug({
                    timestamp: new Date().toISOString(),
                    endpoint: endpoints.manualIncrement,
                    error_type: 'fetch_error',
                    error_message: error.message,
                    error_stack: error.stack
                });

                showResult(`‚ùå ERROR DE CONEXI√ìN\n\nError: ${error.message}`, 'error');
                updateStatus('api', 'offline', 'Error de conexi√≥n');
            }
        });

        // Tab 2: WebSocket Functions
        function connectWebSocket() {
            if (socket && isWebSocketConnected) {
                addWebSocketMessage('‚ö†Ô∏è Ya existe una conexi√≥n WebSocket activa');
                return;
            }

            updateStatus('websocket', 'connecting', 'Conectando...');
            addWebSocketMessage('üîå Iniciando conexi√≥n WebSocket...');

            socket = io(WEBSOCKET_URL, {
                timeout: 5000,
                forceNew: true,
                reconnection: true,
                reconnectionDelay: 10000,
                reconnectionAttempts: 3
            });

            socket.on('connect', () => {
                isWebSocketConnected = true;
                updateStatus('websocket', 'online', 'Conectado a rx.netdomi.com');
                addWebSocketMessage('‚úÖ WebSocket conectado exitosamente!');
                showResult('‚úÖ WebSocket conectado a rx.netdomi.com', 'success');
            });

            socket.on('disconnect', () => {
                isWebSocketConnected = false;
                updateStatus('websocket', 'offline', 'Desconectado');
                addWebSocketMessage('‚ùå WebSocket desconectado');
            });

            socket.on('updateCounter', (data) => {
                const serviceId = parseInt(document.getElementById('ws-service-id').value);
                const isForThisService = !serviceId || data.service_id === serviceId;
                
                if (isForThisService) {
                    addWebSocketMessage(`üìä DATOS RECIBIDOS:\n${JSON.stringify(data, null, 2)}`, true);
                } else {
                    addWebSocketMessage(`üì¢ Mensaje para otra estaci√≥n (${data.service_id})`);
                }
            });

            socket.on('connect_error', (error) => {
                updateStatus('websocket', 'offline', 'Error de conexi√≥n');
                addWebSocketMessage(`‚ùå Error de conexi√≥n: ${error.message}`);
                showResult(`‚ùå Error conectando WebSocket: ${error.message}`, 'error');
            });
        }

        function disconnectWebSocket() {
            if (socket) {
                socket.disconnect();
                socket = null;
                isWebSocketConnected = false;
                updateStatus('websocket', 'offline', 'Desconectado');
                addWebSocketMessage('üîå WebSocket desconectado manualmente');
                showResult('WebSocket desconectado', 'info');
            }
        }

        function sendTestMessage() {
            const serviceId = parseInt(document.getElementById('ws-service-id').value);
            const testPayload = {
                service_id: serviceId,
                current_count: Math.floor(Math.random() * 1000) + 100,
                type: 'test_from_rdd',
                timestamp: new Date().toISOString()
            };

            fetch(endpoints.websocketPing, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(testPayload)
            })
            .then(response => response.json())
            .then(data => {
                addWebSocketMessage(`üì§ Mensaje test enviado:\n${JSON.stringify(testPayload, null, 2)}`);
                showResult(`‚úÖ Mensaje test enviado al WebSocket`, 'success');
            })
            .catch(error => {
                addWebSocketMessage(`‚ùå Error enviando mensaje test: ${error.message}`);
                showResult(`‚ùå Error enviando mensaje test: ${error.message}`, 'error');
            });
        }

        function addWebSocketMessage(message, highlight = false) {
            const messagesDiv = document.getElementById('websocket-messages');
            const contentDiv = document.getElementById('ws-content');
            
            messagesDiv.style.display = 'block';
            
            const timestamp = new Date().toLocaleTimeString();
            const messageElement = document.createElement('div');
            messageElement.style.marginBottom = '10px';
            messageElement.style.padding = '5px';
            messageElement.style.background = highlight ? '#e7f3ff' : 'transparent';
            messageElement.style.border = highlight ? '1px solid #007bff' : 'none';
            messageElement.style.borderRadius = '3px';
            messageElement.innerHTML = `<strong>[${timestamp}]</strong> ${message.replace(/\n/g, '<br>')}`;
            
            contentDiv.appendChild(messageElement);
            contentDiv.scrollTop = contentDiv.scrollHeight;
        }

        // Tab 3: System Check Functions
        async function checkSystemHealth() {
            const results = document.getElementById('system-results');
            results.style.display = 'block';
            results.innerHTML = '<strong>üîç Verificando sistema...</strong><br><br>';

            // Test API Laravel
            try {
                const apiTest = await fetch(`${API_BASE}/rdomi/sts/admin/manual-increment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ service_id: 1, increment_amount: 0, admin_key: 'test' })
                });
                results.innerHTML += `‚úÖ API Laravel: Responde (${apiTest.status})<br>`;
            } catch (error) {
                results.innerHTML += `‚ùå API Laravel: Error - ${error.message}<br>`;
            }

            // Test WebSocket Server Health
            try {
                const wsTest = await fetch(endpoints.health);
                if (wsTest.ok) {
                    results.innerHTML += `‚úÖ WebSocket Server: Online<br>`;
                } else {
                    results.innerHTML += `‚ö†Ô∏è WebSocket Server: Responde con ${wsTest.status}<br>`;
                }
            } catch (error) {
                results.innerHTML += `‚ùå WebSocket Server: No accesible - ${error.message}<br>`;
            }

            // Test CORS
            results.innerHTML += `<br><strong>üåê Testing CORS...</strong><br>`;
            testCORS(results);
        }

        async function testCORS(targetDiv = null) {
            const results = targetDiv || document.getElementById('system-results');
            if (!targetDiv) {
                results.style.display = 'block';
                results.innerHTML = '<strong>üåê Testing CORS...</strong><br><br>';
            }

            try {
                const corsTest = await fetch('https://rx.netdomi.com/socket.io/', {
                    method: 'GET',
                    mode: 'cors'
                });
                results.innerHTML += `‚úÖ CORS: Headers OK (${corsTest.status})<br>`;
                
                // Check for duplicate headers
                const corsHeader = corsTest.headers.get('Access-Control-Allow-Origin');
                if (corsHeader && corsHeader.includes(',')) {
                    results.innerHTML += `‚ö†Ô∏è CORS: ALERTA - Headers duplicados detectados: ${corsHeader}<br>`;
                } else {
                    results.innerHTML += `‚úÖ CORS: Sin duplicaci√≥n de headers<br>`;
                }
            } catch (error) {
                results.innerHTML += `‚ùå CORS: Error - ${error.message}<br>`;
            }
        }

        async function checkWebSocketServer() {
            const results = document.getElementById('system-results');
            results.style.display = 'block';
            results.innerHTML = '<strong>‚ö° Verificando WebSocket Server...</strong><br><br>';

            // Test directo al puerto 3001
            try {
                const directTest = await fetch('https://rx.netdomi.com:3001/health');
                const data = await directTest.json();
                results.innerHTML += `‚úÖ Puerto 3001: ${JSON.stringify(data)}<br>`;
            } catch (error) {
                results.innerHTML += `‚ùå Puerto 3001: ${error.message}<br>`;
            }

            // Test v√≠a Nginx proxy
            try {
                const proxyTest = await fetch('https://rx.netdomi.com/socket.io/');
                results.innerHTML += `‚úÖ Nginx Proxy: Funcional (${proxyTest.status})<br>`;
            } catch (error) {
                results.innerHTML += `‚ùå Nginx Proxy: ${error.message}<br>`;
            }

            // Test conexi√≥n Socket.IO
            results.innerHTML += `<br><strong>üîå Testing Socket.IO...</strong><br>`;
            const testSocket = io(WEBSOCKET_URL, { timeout: 3000 });
            
            testSocket.on('connect', () => {
                results.innerHTML += `‚úÖ Socket.IO: Conexi√≥n exitosa<br>`;
                testSocket.disconnect();
            });

            testSocket.on('connect_error', (error) => {
                results.innerHTML += `‚ùå Socket.IO: Error de conexi√≥n - ${error.message}<br>`;
            });
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            showDebug({
                timestamp: new Date().toISOString(),
                current_url: window.location.href,
                api_base: API_BASE,
                websocket_url: WEBSOCKET_URL,
                endpoints: endpoints,
                status: 'Sistema RDD cargado - Todas las funciones disponibles'
            });

            // Auto-verificar sistema al cargar
            setTimeout(checkSystemHealth, 1000);
        });
    </script>
</body>
</html>